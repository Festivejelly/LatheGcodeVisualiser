<!DOCTYPE html>
<html>

<head>
    <title>G-Code Visualizer</title>
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
  <script type="module" crossorigin>
var ce=Object.defineProperty;var de=(n,e,t)=>e in n?ce(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>(de(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const u of o)if(u.type==="childList")for(const w of u.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&a(w)}).observe(document,{childList:!0,subtree:!0});function t(o){const u={};return o.integrity&&(u.integrity=o.integrity),o.referrerPolicy&&(u.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?u.credentials="include":o.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function a(o){if(o.ep)return;o.ep=!0;const u=t(o);fetch(o.href,u)}})();class ue{constructor(e){c(this,"port",null);c(this,"readTimeout",0);c(this,"reader",null);c(this,"writer",null);c(this,"isOn",!1);c(this,"waitForOkOrError",!1);c(this,"lines",[]);c(this,"lineIndex",0);c(this,"unparsedResponse","");c(this,"error","");c(this,"statusReceived",!1);c(this,"z",0);c(this,"x",0);c(this,"feed",0);c(this,"rpm",0);this.statusChangeCallback=e}getStatus(){return{condition:this.port?this.isOn?"run":"idle":"disconnected",error:this.error,progress:this.lines.length?this.lineIndex/this.lines.length:0,z:this.z,x:this.x,feed:this.feed,rpm:this.rpm}}setStatus(e){e.startsWith("<")&&(e=e.substring(1)),e.endsWith(">")&&(e=e.slice(0,-1));const t=e.split("|");if(t.length>=3){if(this.statusReceived=!0,t[1].startsWith("WPos:")){const a=t[1].substring(5).split(",");this.z=Number(a[2]),this.x=Number(a[0])}if(t[2].startsWith("FS:")){const a=t[2].substring(3).split(",");this.feed=Number(a[0]),this.rpm=Number(a[1])}}this.statusChangeCallback()}setError(e){this.error=e,this.statusChangeCallback()}isCommand(e){return["!","~","?","="].some(a=>e[0].startsWith(a))}async start(e){if(e){if(this.lines=e.split(`
`),!this.isCommand(this.lines)&&!this.rpm){this.setError("Spindle is not running, turn it on first");return}if(this.isOn&&this.stop(),!(!this.port&&(await this.selectPort(),!this.port))){if(await this.askForStatus(),!await he(()=>this.statusReceived)){this.setError("Device is not reponding, is it in GCODE mode?");return}this.lineIndex=0,this.isOn=!0,this.setError(""),this.waitForOkOrError=!1,this.unparsedResponse="",this.write("~"),this.writeCurrentLine(),this.statusChangeCallback()}}}async stop(){await this.write("!"),this.isOn&&(this.isOn=!1,this.askForStatus(),this.statusChangeCallback())}async write(e){if(this.port){if(q(`command: ${e}`),console.log("command: ",e),!this.port.writable){e!="?"&&this.setError("Port is not writable, try reconnecting the USB and switching to GCODE mode.");return}if(!this.writer)try{const t=new TextEncoderStream;t.readable.pipeTo(this.port.writable),this.writer=t.writable.getWriter()}catch(t){this.setError("Failed to write: "+t);return}await this.writer.write(e)}}async writeCurrentLine(){if(!this.isOn||this.waitForOkOrError)return;if(this.lineIndex>=this.lines.length){this.stop();return}const e=this.lines[this.lineIndex].split(";")[0].trim();if(!e){this.lineIndex++,this.writeCurrentLine();return}this.waitForOkOrError=!0,await this.write(e+`
`),await this.readFromPort()}async processResponse(e){this.unparsedResponse=(this.unparsedResponse+e).trimStart(),q(`command: ${e}`),console.log(`response: "${e}"`);const t=this.unparsedResponse.match(/(<[^>]+>)/);if(t&&t.length>1){t.shift();for(const a of t)this.unparsedResponse=this.unparsedResponse.replace(a,"");this.setStatus(t.pop())}this.unparsedResponse.startsWith("error:")?(this.setError(this.unparsedResponse),this.unparsedResponse="",this.stop()):this.unparsedResponse.startsWith("ok")&&(this.unparsedResponse="",this.waitForOkOrError=!1,this.lineIndex++,this.statusChangeCallback(),this.isOn&&await this.writeCurrentLine())}async selectPort(){if(this.port&&this.closePort(),navigator.serial?this.port=await navigator.serial.requestPort():(this.error="This browser does not support Serial API, try Chrome or Edge",this.statusChangeCallback()),this.port)try{await this.port.open({baudRate:115200}),this.statusChangeCallback(),this.readSoon()}catch(e){this.setError(`Unable to open port - likely some other app is using it - try closing Arduino IDE.
${e}`),this.closePort()}}async askForStatus(){try{await this.write("?")}catch(e){this.setError(`Device disconnected? ${e}`),this.closePort()}}readSoon(){clearTimeout(this.readTimeout),this.readTimeout=window.setTimeout(()=>this.readFromPort(),200)}async readFromPort(){if(this.port)try{if(!this.port.readable){this.readSoon();return}if(!this.reader){const t=new TextDecoderStream;this.port.readable.pipeTo(t.writable),this.reader=t.readable.getReader()}const{value:e}=await this.reader.read();if(!e){this.readSoon();return}await this.processResponse(e),this.readSoon()}catch(e){this.setError(e.message||String(e)),this.closePort()}}async closePort(){if(this.port){clearTimeout(this.readTimeout),this.readTimeout=0,this.reader&&(this.reader.releaseLock&&this.reader.releaseLock(),this.reader=null),this.writer&&(this.writer.releaseLock&&this.writer.releaseLock(),this.writer=null);try{await this.port.close()}catch{}this.port=null,this.statusReceived=!1,this.z=0,this.x=0,this.feed=0,this.rpm=0}}}function q(n){var e=g.getSession(),t=e.getLength(),a=new Date().toLocaleTimeString(),o=`[${a}] ${n}
`;e.insert({row:t,column:0},o)}function he(n){return new Promise(e=>{let t=0;function a(){n()?e(!0):t>=10?e(!1):(t++,setTimeout(a,100))}a()})}class pe{constructor(){c(this,"sendButton");c(this,"stopButton");c(this,"senderError");c(this,"runProgress");c(this,"sender",null);this.senderError=document.querySelector(".senderError"),this.runProgress=document.getElementsByTagName("progress")[0],this.sendButton=document.getElementById("gcodeSenderButton"),this.sendButton.addEventListener("click",()=>{this.sender||(this.sender=new ue(()=>this.senderStatusChange())),this.sender.start(h.getValue())}),this.stopButton=document.getElementById("stopButton"),this.stopButton.addEventListener("click",()=>this.sender.stop()),this.stopButton.style.display="none"}hide(){}senderStatusChange(){if(!this.sender)return;const e=this.sender.getStatus(),t=e.condition==="run";this.runProgress&&(this.runProgress.value=e.progress,this.runProgress.style.display=t?"block":"none"),this.stopButton&&(this.stopButton.style.display=t?"inline-block":"none"),this.sendButton&&(this.sendButton.style.display=t?"none":"inline-block"),this.senderError&&(e.error?(this.senderError.style.display="block",this.senderError.innerText=e.error,this.showError(),this.appendLineToResponseEditor(e.error)):(this.hideError(),this.senderError.innerText=""))}appendLineToResponseEditor(e){var t=g.getSession(),a=t.getLength(),o=new Date().toLocaleTimeString(),u=`[${o}] ${e}
`;t.insert({row:a,column:0},u)}showError(){this.senderError.style.display="block"}hideError(){this.senderError.style.display="none"}}const h=ace.edit("gcodeEditor"),g=ace.edit("gcodeResponseEditor"),fe="#DC143C",ge="#6B8E23";document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("gcodeCanvas"),e=n.getContext("2d"),t=document.getElementById("fileInput"),a=document.getElementById("simulateButton"),o=document.getElementById("showCuts"),u=document.getElementById("showNonCuts"),w=document.getElementById("sliderLabel"),y=document.getElementById("progressSlider"),G=document.getElementById("sliderContainer"),z=document.getElementById("displayOptionsContainer"),A=document.getElementById("clearButton"),W=document.querySelector(".saveGCodeNameInput"),m=document.querySelector(".loadGCodeSelect"),H=document.querySelector(".loadGCodeButton"),j=document.querySelector(".saveGCodeButton"),U=document.querySelector(".deleteGCodeButton"),_=document.getElementById("gcodeSenderContainer"),Z=document.getElementById("gcodeResponseContainer"),K=document.getElementById("gcodeSenderButton");j.addEventListener("click",()=>Y()),H.addEventListener("click",()=>J()),U.addEventListener("click",()=>Q()),new pe,N(),h.setTheme("ace/theme/github_dark"),h.session.setMode("ace/mode/plain_text"),h.setShowPrintMargin(!1),g.setTheme("ace/theme/monokai"),g.session.setMode("ace/mode/text"),g.setReadOnly(!0),g.setShowPrintMargin(!1),K.addEventListener("click",()=>{Z.style.display="block"}),g.getSession().on("change",()=>{setTimeout(()=>{var s=g.getSession().getLength();g.scrollToLine(s,!0,!0,function(){})},0)}),$();let x=0,R=0,B=0,T=0,I=0,O=0,D=1,P=0,F=0,b=20,f=[],k=[];A.addEventListener("click",()=>{h.setValue(""),$(),e&&e.clearRect(0,0,n.width,n.height),t.value="",y.value="0",G.style.display="none",z.style.display="none",Z.style.display="none"}),t.addEventListener("change",s=>{if(s.target instanceof HTMLInputElement&&s.target.files&&s.target.files.length>0){const i=s.target.files[0];i&&te(i)}}),a.addEventListener("click",()=>{const s=h.getValue();s&&(k=se(s),M(k,f),G.style.display="block",z.style.display="block",y.max=f.length.toString(),y.value=y.min,o.addEventListener("change",V),u.addEventListener("change",V),y.oninput=()=>{if(!e)return;const i=Math.floor(parseInt(y.value));if(i<f.length){const l=f[i];M(k,f,i),ee(l)}},_.style.display="block")});function Y(){const s=W.value.trim();if(!s)return;const i=`gCode-${s}`;localStorage.setItem(i,h.getValue()),N(i),W.value=""}function J(){const s=m.value,i=localStorage.getItem(s);i&&h.setValue(i)}function Q(){const s=m.value;localStorage.removeItem(s),N()}function N(s){m.innerHTML="";let i=!1;for(let l=0;l<localStorage.length;l++){const d=localStorage.key(l);if(d&&d!=="latheCode"&&d.startsWith("gCode-")){i=!0;const r=document.createElement("option"),E=d.replace("gCode-","");r.value=d,r.textContent=E,m.appendChild(r),d===s&&(r.selected=!0)}}if(i){const l=Array.from(m.options).sort((d,r)=>d.text.localeCompare(r.text));m.innerHTML="",l.forEach(d=>{m.appendChild(d)})}else{const l=document.createElement("option");l.textContent="No items saved",l.disabled=!0,m.appendChild(l)}}function $(){h.getValue()===""&&(h.setValue("Paste your gcode here or click choose file to upload"),h.gotoLine(1,0),h.on("focus",function(){h.getValue()==="Paste your gcode here or click choose file to upload"&&h.setValue("")}))}function ee(s){(s==null?void 0:s.lineNumber)!==void 0?(h.gotoLine(s.lineNumber,0,!0),w.innerHTML=`Line:${s.lineNumber}<br>${s==null?void 0:s.originalLine}`||""):w.innerHTML=""}function te(s){const i=new FileReader;i.onload=l=>{const d=l.target.result;h.setValue(d)},i.readAsText(s)}function se(s){const i=[];let l=!1;return f=[],s.split(`
`).forEach((r,E)=>{const p={isRelative:l,isCut:r.includes("; cut")},v=r.match(/([GXYZF])([0-9.-]+)/g);if(v==null||v.forEach(C=>{const S=parseFloat(C.slice(1));switch(C[0]){case"G":S===90&&(p.isRelative=!1),S===91&&(p.isRelative=!0);break;case"X":p.x=S;break;case"Z":p.z=S;break}}),p.x!==void 0||p.z!==void 0){const C={...p,lineNumber:E+1,originalLine:r};i.push(C),p.isRelative&&f.push(C)}l=p.isRelative}),b=ie(f,n.width,n.height),i}function V(){y.value="0",M(k,f,f.length)}function ie(s,i,l){let d=0,r=0,E=0,p=0,v=0;s.forEach(L=>{L.isRelative&&(L.x!==void 0&&(d+=L.x),L.z!==void 0&&(r+=L.z)),E=Math.max(E,Math.abs(d)),p=Math.max(p,Math.abs(r)),v=Math.min(v,r)});const C=E,S=p-v;let ne=40;const oe=l/2,X=1,ae=oe/C-X,le=i/S-X;return Math.min(ae,le,ne)}function M(s,i,l){if(!e)return;e.clearRect(0,0,n.width,n.height),x=0,R=0;for(const r of s)if(!r.isRelative)r.x!==void 0&&(I=r.x*b),r.z!==void 0&&(O=r.z*b);else if(r.isRelative)break;B=n.height/2-I,T=n.width-O-D;const d=l!==void 0?Math.min(l+1,i.length):i.length;for(let r=0;r<d;r++)re(i[r])}function re(s){e&&(e.lineWidth=2,s.isRelative&&(x+=s.x??0,R+=s.z??0),P=n.height/2-I-x*b,F=n.width-O-R*b-D,(s.isCut&&o.checked||!s.isCut&&u.checked)&&(e.beginPath(),e.strokeStyle=s.isCut?fe:ge,e.moveTo(T,B),e.lineTo(F,P),e.stroke()),B=P,T=F)}});

</script>
  <style>
:root{font-family:Inter,system-ui,Avenir,Helvetica,Arial,sans-serif;line-height:1.5;font-weight:400;color-scheme:light dark;color:#ffffffde;background-color:#242424;font-synthesis:none;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}a{font-weight:500;color:#646cff;text-decoration:inherit}a:hover{color:#535bf2}h1{font-size:3.2em;line-height:1.1}#app{max-width:1280px;margin:0 auto;padding:2rem;text-align:center}.logo{height:6em;padding:1.5em;will-change:filter;transition:filter .3s}.logo:hover{filter:drop-shadow(0 0 2em #646cffaa)}.logo.vanilla:hover{filter:drop-shadow(0 0 2em #3178c6aa)}.card{padding:2em}.read-the-docs{color:#888}button{border-radius:3px;border:1px solid transparent;padding:.6em 1.2em;font-size:1em;font-weight:500;font-family:inherit;background-color:#1a1a1a;cursor:pointer;transition:background-color .25s}button:hover{background-color:#646cff}button:focus,button:focus-visible{outline:4px auto -webkit-focus-ring-color}@media (prefers-color-scheme: light){:root{color:#213547;background-color:#fff}a:hover{color:#747bff}button{background-color:#f9f9f9}}.main-container{display:flex;align-items:start}.controls-container{display:flex;flex-direction:column;align-items:center;justify-content:center;margin:5px;width:800px;max-width:1280px;text-align:center;border:1px solid #ccc}.canvas-container{width:100%;height:100%;align-items:center;margin:5px}.innerContainer{margin:5px;align-items:center;width:auto}.innerContainer.toolbar{display:flex;align-items:center;gap:5px;padding:2px}.saveGCodeNameInput,.loadGCodeSelect{flex-grow:1}#gcodeCanvas{border:1px solid #ccc}#gcodeInput{position:relative;background:transparent;width:100%;height:240px;font-family:monospace;font-size:13px;line-height:1.5;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}#gcodeContainer{position:relative;width:100%}#gcodeSenderContainer{display:block}.save-group,.load-group,.import-export-group{display:flex;flex-direction:row;align-items:center;gap:10px}.toolbar input[type=text],.toolbar select{max-width:200px;width:100%;box-sizing:border-box;border:1px solid #ccc;margin:0;padding:.375rem .75rem;font-size:1rem;line-height:1.5}input[type=file]::file-selector-button{border:2px solid #6c5ce7;padding:.2em .4em;border-radius:.2em;background-color:#1a1a1a;transition:.25s}input[type=file]::-ms-browse:hover{background-color:#646cff}input[type=file]::-webkit-file-upload-button:hover{background-color:#646cff}input[type=file]::file-selector-button:hover{background-color:#646cff}.bottom-container{margin:5px}#gcodeResponseContainer{border:1px solid #ccc;width:100%;display:flex;flex-direction:column;align-items:center;margin-top:5px}.senderError{display:none;color:#fff;background-color:red;padding:10px;border-radius:5px;animation:flashError 1s infinite}@keyframes flashError{0%,to{opacity:1}50%{opacity:0}}

</style>
</head>

<body>
    <div class="main-container">
        <div class="controls-container">
            <div id="gcodeContainer" style="position: relative;">
                <div id="gcodeEditor" style="height: 200px; width: 100%;"></div>
            </div>
            <div class="innerContainer">
                <input type="file" id="fileInput" accept=".txt,.gcode">
            </div>
            <div class="innerContainer">
                <button id="simulateButton">Simulate</button>
                <button id="clearButton">Clear</button>
            </div>
            <div id="sliderContainer" class="innerContainer" style="display: none; width: 400px;">
                <input type="range" id="progressSlider" min="0" max="100" value="0" style="width: 100%;">
                <div id="sliderLabel" style="text-align: center;"><br>Drag to see moves</div>
            </div>
            <div id="displayOptionsContainer" class="innerContainer" style="display: none;">
                <input type="checkbox" id="showCuts" checked> Show Cut Moves
                </label>
                <label>
                    <input type="checkbox" id="showNonCuts" checked>
                    Show Non-Cut Moves
                </label>
            </div>
            <div class="innerContainer" id="loadAndSave">
                <hr>
                <div class="innerContainer toolbar">
                    <input type="text" class="saveGCodeNameInput" placeholder="name of save"></input>
                    <button class="saveGCodeButton" title="Save GCode to local browser storage">Save local</button>
                </div>
                <div class="innerContainer toolbar">
                    <select class="loadGCodeSelect"></select>
                    <button class="loadGCodeButton" title="Load GCode from local browser storage">Load</button>
                    <button class="deleteGCodeButton" title="Delete GCode from local browser storage">Delete</button>
                </div>
                <hr>
            </div>

            <div id="gcodeSenderContainer" class="innerContainer">

                <span>Send GCode to CNC</span>

                <div class="innerContainer">
                    <button id="gcodeSenderButton" title="Send GCode to CNC">Send</button>
                    <button id="stopButton" style="display: none;">Stop</button>
                </div>
            </div>

            <div id="gcodeResponseContainer" style="display: none;">
                <div id="gcodeResponseHeader">GCode Responses</div>
                <div id="gcodeResponseEditor" style="height: 200px; width: 100%;"></div>
                <div class="senderError" style="display: none;"></div>
                <progress max="1" style="display: none;"></progress>
            </div>
        </div>
        <div class="canvas-container">
            <canvas id="gcodeCanvas" width="800" height="600" style="background-color: #242424;"></canvas>
        </div>
    </div>
</body>

</html>